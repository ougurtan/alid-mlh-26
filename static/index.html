<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ALLERGUESS</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
      background-image: url("/static/30362838_7688702.webp");
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-position: center;
    }
    .page-wrapper {
      background: rgba(255,255,255,0.9);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }
    .title-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    h1 { margin: 0; font-size: 2.4rem; letter-spacing: 1px; }
    .title-icon { width: 48px; height: 48px; object-fit: contain; }
    .input-card {
      background: #ffffff;
      padding: 16px 20px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    label { display: block; margin-top: 8px; font-weight: bold; }
    textarea, input[type="text"] {
      width: 100%; padding: 8px; border-radius: 6px;
      border: 1px solid #ccc; box-sizing: border-box;
    }
    textarea { height: 70px; resize: vertical; }
    button {
      margin-top: 10px; padding: 10px 18px; border-radius: 6px;
      border: none; background: #0066ff; color: white;
      font-weight: bold; cursor: pointer;
    }
    button:hover { background: #004ecc; }
    button:disabled { background: #999; cursor: not-allowed; }
    .error-msg { color: #b00020; font-weight: bold; margin-top: 10px; }
    .result-card {
      background: #ffffff; padding: 20px; border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .top-section {
      display: grid; grid-template-columns: 260px 1fr;
      gap: 20px; align-items: center;
    }
    @media (max-width: 800px) { .top-section { grid-template-columns: 1fr; } }
    .circle-wrapper {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    .circle {
      width: 180px; height: 180px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #333; font-size: 2.2rem; font-weight: bold;
    }
    .circle-green { background: #dcf7df; border: 6px solid #1b5e20; color: #1b5e20; }
    .circle-yellow { background: #fff4c2; border: 6px solid #8a6d00; color: #8a6d00; }
    .circle-red { background: #ffdddd; border: 6px solid #b00020; color: #b00020; }
    .safety-text { margin-top: 8px; font-size: 1.1rem; font-weight: bold; }
    .main-info { display: flex; flex-direction: column; gap: 10px; }
    .food-name { font-size: 2rem; font-weight: 700; }
    .food-image {
      width: 260px; height: 160px; border-radius: 10px;
      background-color: #eee; background-size: cover;
      background-position: center; margin-top: 6px;
      display: flex; align-items: center; justify-content: center;
      color: #999; font-size: 0.9rem;
    }
    .tags-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .tag-box {
      padding: 6px 10px; border-radius: 8px; background: #ffeaf4;
      font-size: 0.85rem; border: 1px solid #ffb6d9; color: #7a2040;
    }
    .links-row {
      margin-top: 14px; display: flex; flex-wrap: wrap;
      gap: 12px; font-weight: bold;
    }
    .link-like { color: #0066ff; cursor: pointer; text-decoration: underline; }
    .predictions-section { margin-top: 20px; }
    .prediction-item {
      display: flex; justify-content: space-between; padding: 6px 10px;
      border-radius: 8px; background: #ffeef7; margin-bottom: 6px;
      cursor: pointer; border: 1px solid #ffb6d9;
    }
    .prediction-item:hover { background: #e9f0ff; }
    .prediction-item.active { background: #d4e8ff; border-color: #0066ff; }
    .prediction-name { font-weight: 600; }
    .prediction-percent { font-weight: 600; }
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4);
      display: none; align-items: center; justify-content: center; z-index: 1000;
    }
    .modal {
      background: #ffffff; max-width: 600px; width: 90%;
      max-height: 80vh; overflow-y: auto; border-radius: 10px;
      padding: 16px 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.25);
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { margin: 0; }
    .close-btn { cursor: pointer; font-size: 1.3rem; border: none; background: none; }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <div class="title-row">
      <h1>ALLERGUESS</h1>
      <img src="/static/D6C59661-77D7-498B-8FFA-611BB833256F.webp" alt="logo" class="title-icon" />
    </div>

    <div class="input-card">
      <label for="description">Dish description</label>
      <textarea id="description" placeholder="Example: flaky pastry with cheese and spinach, my grandma made it, she was from Turkey"></textarea>
      <label for="allergens">Allergens to check (comma separated)</label>
      <input id="allergens" type="text" placeholder="Example: nuts, dairy" />
      <button id="analyzeBtn">Analyze dish</button>
      <div id="errorMsg" class="error-msg" style="display:none;"></div>
    </div>

    <div id="resultCard" class="result-card" style="display:none;">
      <div class="top-section">
        <div class="circle-wrapper">
          <div id="riskCircle" class="circle circle-green">0%</div>
          <div id="safetyText" class="safety-text">Safe to eat!</div>
        </div>
        <div class="main-info">
          <div class="food-name" id="foodName">Dish name</div>
          <div id="foodImage" class="food-image">üçΩÔ∏è Loading...</div>
          <div class="tags-row">
            <div class="tag-box" id="continentTag">Continent: -</div>
            <div class="tag-box" id="originTag">Origin: -</div>
            <div class="tag-box" id="confidenceTag" style="background:#dcf7df;border-color:#1b5e20;color:#1b5e20;font-weight:bold;">ML Confidence: -</div>
          </div>
          <div class="links-row">
            <span id="historyLink" class="link-like">History</span>
            <span id="recipeLink" class="link-like">Recipe</span>
            <span id="allergensLink" class="link-like">Allergens</span>
            <span id="swapsLink" class="link-like">Eco Swaps</span>
            <span id="youtubeLink" class="link-like">YouTube</span>
          </div>
        </div>
      </div>
      <div class="predictions-section">
        <h3>Other possible dishes (click to view)</h3>
        <div id="predictionsList"></div>
      </div>
    </div>
  </div>

  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">Title</h2>
        <button class="close-btn" id="modalCloseBtn">&times;</button>
      </div>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    const analyzeBtn = document.getElementById('analyzeBtn');
    const resultCard = document.getElementById('resultCard');
    const errorMsg = document.getElementById('errorMsg');
    const riskCircle = document.getElementById('riskCircle');
    const safetyText = document.getElementById('safetyText');
    const foodName = document.getElementById('foodName');
    const foodImage = document.getElementById('foodImage');
    const continentTag = document.getElementById('continentTag');
    const originTag = document.getElementById('originTag');
    const confidenceTag = document.getElementById('confidenceTag');
    const predictionsList = document.getElementById('predictionsList');
    const historyLink = document.getElementById('historyLink');
    const recipeLink = document.getElementById('recipeLink');
    const allergensLink = document.getElementById('allergensLink');
    const swapsLink = document.getElementById('swapsLink');
    const youtubeLink = document.getElementById('youtubeLink');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    const modalCloseBtn = document.getElementById('modalCloseBtn');

    function setCircleColor(percent) {
      riskCircle.classList.remove('circle-green', 'circle-yellow', 'circle-red');
      if (percent >= 75) riskCircle.classList.add('circle-red');
      else if (percent >= 35) riskCircle.classList.add('circle-yellow');
      else riskCircle.classList.add('circle-green');
    }

    function openModal(title, html) {
      modalTitle.textContent = title;
      modalContent.innerHTML = html;
      modalBackdrop.style.display = 'flex';
    }
    function closeModal() { modalBackdrop.style.display = 'none'; }
    modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });
    modalCloseBtn.addEventListener('click', closeModal);

    function setDishImage(dishName) {
      foodImage.textContent = 'üçΩÔ∏è Loading...';
      foodImage.style.backgroundImage = 'none';

      // Fetch real image from Wikipedia via our backend
      fetch('/api/dish-image?dish=' + encodeURIComponent(dishName))
        .then(r => r.json())
        .then(data => {
          if (data.image_url) {
            const img = new Image();
            img.onload = () => {
              foodImage.textContent = '';
              foodImage.style.backgroundImage = "url('" + data.image_url + "')";
            };
            img.onerror = () => {
              foodImage.textContent = 'üçΩÔ∏è ' + dishName;
              foodImage.style.background = 'linear-gradient(135deg, #ffeef7 0%, #fff4c2 100%)';
            };
            img.src = data.image_url;
          } else {
            foodImage.textContent = 'üçΩÔ∏è ' + dishName;
            foodImage.style.background = 'linear-gradient(135deg, #ffeef7 0%, #fff4c2 100%)';
          }
        })
        .catch(() => {
          foodImage.textContent = 'üçΩÔ∏è ' + dishName;
          foodImage.style.background = 'linear-gradient(135deg, #ffeef7 0%, #fff4c2 100%)';
        });
    }

    // MAIN BUTTON
    analyzeBtn.addEventListener('click', async () => {
      const description = document.getElementById('description').value.trim();
      const allergensText = document.getElementById('allergens').value.trim();
      if (!description) { alert('Please describe the dish.'); return; }

      const allergens = allergensText.split(',').map(a => a.trim()).filter(a => a.length > 0);

      analyzeBtn.disabled = true;
      analyzeBtn.textContent = 'Analyzing...';
      errorMsg.style.display = 'none';
      resultCard.style.display = 'none';

      try {
        const response = await fetch('/api/recover', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ description, allergies: allergens })
        });
        if (!response.ok) throw new Error('Server returned ' + response.status);
        const modelOutput = await response.json();
        if (modelOutput.error) throw new Error(modelOutput.error);
        renderMainView(modelOutput, allergens, 0);
        resultCard.style.display = 'block';
      } catch (err) {
        errorMsg.textContent = 'Error: ' + err.message + '. Is the server running?';
        errorMsg.style.display = 'block';
      }

      analyzeBtn.disabled = false;
      analyzeBtn.textContent = 'Analyze dish';
    });

    function renderMainView(data, userAllergens, activeIndex) {
      const geminiDishes = (data.dish_info && data.dish_info.dishes) || [];
      const classification = data.classification || {};
      const predictions = (classification && classification.dish_predictions) || [];
      const activePred = predictions[activeIndex] || predictions[0] || {};

      // Get the Gemini info for the active dish
      const d = geminiDishes[activeIndex] || geminiDishes[0] || {};

      const displayDish = activePred.dish || d.dish_name || 'Unknown dish';

      // Allergen risk from this dish's Gemini data
      const warnings = d.allergen_warnings || [];
      const userLower = userAllergens.map(a => a.toLowerCase());
      const riskPercent = Math.round(d.allergen_risk_percent || 0);
      const riskExplanation = d.risk_explanation || '';

      riskCircle.textContent = riskPercent + '%';
      setCircleColor(riskPercent);
      if (riskPercent === 0) safetyText.textContent = '‚úÖ Safe to eat!';
      else if (riskPercent <= 50) safetyText.textContent = '‚ö†Ô∏è ' + riskPercent + '% risk';
      else safetyText.textContent = 'üö´ ' + riskPercent + '% risk';

      foodName.textContent = displayDish;
      setDishImage(displayDish);

      continentTag.textContent = 'Continent: ' + (d.continent || activePred.continent || '-');
      originTag.textContent = 'Origin: ' + (d.region_of_origin || activePred.region || '-');

      if (activePred.confidence) {
        const c = Math.round(activePred.confidence * 100);
        confidenceTag.textContent = 'ML Confidence: ' + c + '%';
        if (c >= 50) { confidenceTag.style.background = '#dcf7df'; confidenceTag.style.borderColor = '#1b5e20'; confidenceTag.style.color = '#1b5e20'; }
        else if (c >= 25) { confidenceTag.style.background = '#fff4c2'; confidenceTag.style.borderColor = '#8a6d00'; confidenceTag.style.color = '#8a6d00'; }
        else { confidenceTag.style.background = '#ffdddd'; confidenceTag.style.borderColor = '#b00020'; confidenceTag.style.color = '#b00020'; }
      } else {
        confidenceTag.textContent = 'ML: not in training set';
        confidenceTag.style.background = '#f0f0f0'; confidenceTag.style.borderColor = '#ccc'; confidenceTag.style.color = '#666';
      }

      historyLink.onclick = () => openModal('History of ' + displayDish,
        '<p>' + (d.history || 'No history available.') + '</p>' +
        (d.fun_fact ? '<p><strong>üí° Fun fact:</strong> ' + d.fun_fact + '</p>' : ''));

      const recipe = d.recipe || {};
      recipeLink.onclick = () => openModal('Recipe for ' + displayDish,
        '<p>Servings: ' + (recipe.servings||'?') + ', Prep: ' + (recipe.prep_time||'?') + ', Cook: ' + (recipe.cook_time||'?') + '</p>' +
        '<h3>Ingredients</h3><ul>' + (recipe.ingredients||[]).map(i => '<li>'+i+'</li>').join('') + '</ul>' +
        '<h3>Steps</h3><ol>' + (recipe.steps||[]).map(s => '<li>'+s+'</li>').join('') + '</ol>' +
        (d.tips ? '<p><strong>üí° Tip:</strong> ' + d.tips + '</p>' : ''));

      allergensLink.onclick = () => {
        let h = '';
        if (riskExplanation) {
          h += '<div style="padding:12px;margin-bottom:12px;border-radius:8px;background:#f0f0f7;border-left:4px solid #666;">' +
            '<strong>Risk for ' + displayDish + ':</strong> ' + riskExplanation + '</div>';
        }
        const safeV = d.safe_variants || [];
        const unsafeV = d.unsafe_variants || [];
        if (safeV.length > 0) {
          h += '<div style="padding:10px;margin-bottom:8px;border-radius:8px;background:#dcf7df;border-left:4px solid #1b5e20;">' +
            '<strong>‚úÖ Safe versions:</strong> ' + safeV.join(', ') + '</div>';
        }
        if (unsafeV.length > 0) {
          h += '<div style="padding:10px;margin-bottom:8px;border-radius:8px;background:#ffdddd;border-left:4px solid #b00020;">' +
            '<strong>üö´ Unsafe versions:</strong> ' + unsafeV.join(', ') + '</div>';
        }
        if (warnings.length > 0) {
          h += '<h3 style="margin-top:12px;">Ingredient Details</h3>';
          warnings.forEach(w => {
            const m = userLower.includes((w.allergen||'').toLowerCase());
            h += '<div style="padding:10px;margin-bottom:8px;border-radius:8px;background:' + (m?'#ffdddd':'#fff4c2') +
              ';border-left:4px solid ' + (m?'#b00020':'#8a6d00') + ';">' +
              '<strong style="text-transform:uppercase;font-size:0.85rem;">‚ö†Ô∏è ' + w.allergen + '</strong><br>' +
              'Found in: <strong>' + w.found_in + '</strong><br>' +
              (w.variant_note ? '<em>' + w.variant_note + '</em><br>' : '') +
              (w.substitute ? '‚úÖ Sub: <strong>' + w.substitute + '</strong>' : '') + '</div>';
          });
        } else { h += '<p style="color:#1b5e20;font-weight:bold;">‚úÖ No allergens detected!</p>'; }
        openModal('Allergen Report', h);
      };

      const swaps = d.sustainable_swaps || [];
      swapsLink.onclick = () => {
        let h = '';
        if (swaps.length > 0) {
          swaps.forEach(s => {
            h += '<div style="padding:10px;margin-bottom:8px;border-radius:8px;background:#f0f7ed;border-left:4px solid #6b8f71;">' +
              '<strong><s>' + s.original + '</s> ‚Üí ' + s.swap + '</strong><br>' +
              '<span style="color:#666;">' + (s.why||'') + (s.impact ? ' ¬∑ ' + s.impact : '') + '</span></div>';
          });
        } else { h = '<p>No swaps available.</p>'; }
        openModal('üå± Future Food Swaps', h);
      };

      youtubeLink.onclick = () => {
        const q = encodeURIComponent(d.youtube_search_query || displayDish);
        openModal('YouTube', '<p><a href="https://www.youtube.com/results?search_query=' + q +
          '" target="_blank" style="font-size:1.1rem;">‚ñ∂ Watch how to cook ' + displayDish + '</a></p>');
      };

      predictionsList.innerHTML = '';
      predictions.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'prediction-item' + (i === activeIndex ? ' active' : '');
        const name = document.createElement('span');
        name.className = 'prediction-name';
        name.textContent = p.dish + ' ‚Äî ' + p.region;

        const pct = document.createElement('span');
        pct.className = 'prediction-percent';
        const confText = Math.round(p.confidence * 100) + '% match';
        const gDish = geminiDishes[i];
        if (gDish && gDish.allergen_risk_percent !== undefined && userAllergens.length > 0) {
          const dr = Math.round(gDish.allergen_risk_percent);
          const rc = dr >= 75 ? '#b00020' : dr >= 35 ? '#8a6d00' : '#1b5e20';
          pct.innerHTML = confText + ' <span style="color:' + rc + ';margin-left:6px;">‚ö†Ô∏è' + dr + '% risk</span>';
        } else {
          pct.textContent = confText;
        }

        div.appendChild(name);
        div.appendChild(pct);
        div.addEventListener('click', () => renderMainView(data, userAllergens, i));
        predictionsList.appendChild(div);
      });
    }
  </script>
</body>
</html>
